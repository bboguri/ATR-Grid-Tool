<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATRç½‘æ ¼è®¡ç®—å™¨</title>
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;background: #f4f9ff;padding: 15px;display: flex;justify-content: center;line-height: 1.5;}
        .card {background: white;padding: 25px;border-radius: 16px;box-shadow: 0 10px 30px rgba(0,0,0,0.08);width: 100%;max-width: 500px;}
        
        h2 {color: #1d1d1d;text-align: center;margin-bottom: 6px;font-weight: 600;font-size: 20px;}
        .section-title {font-size: 16px;font-weight: 600;color: #007aff;margin: 20px 0 12px;border-bottom: 1px solid #eee;padding-bottom: 6px;}
        .version {text-align: center;font-size: 12px;color: #888;margin-bottom: 20px;}
        
        .input-group {margin-bottom: 18px;}
        label {display: block;font-size: 15px;font-weight: 600;color: #333;margin-bottom: 6px;}
        .tip {font-size: 12px;color: #888;display: block;margin-bottom: 6px;}
        input, select {width: 100%;padding: 12px 15px;border: 1px solid #ddd;border-radius: 8px;box-sizing: border-box;font-size: 15px;}
        input:focus, select:focus {border-color: #007aff;outline: none;box-shadow: 0 0 0 4px rgba(0,122,205,0.2);}
        
        .btn-group {display: grid;grid-template-columns: 1fr 1fr;gap: 10px;margin-top: 10px;}
        button {padding: 14px;border: none;border-radius: 8px;font-size: 15px;font-weight: 600;cursor: pointer;}
        .btn-primary {background: #007aff;color: white;}
        .btn-clear {background: #e6e6e6;color: #666;}
        
        #result {margin-top: 20px;display: none;opacity: 0;transform: translateY(10px);transition: all 0.3s;}
        #result.show {display: block;opacity: 1;transform: translateY(0);}

        .grid-info {font-size: 15px;line-height: 2.2;}
        .info-card {background: #f9fafc;padding: 12px 15px;border-radius: 8px;border: 1px solid #eee;font-size: 15px;}
        .val {display: inline;font-size: 15px;font-weight: bold;}
        .mode-desc {font-size: 12px;color: #888;margin-top: 4px;}
        
        .warn-safe {color: #34c759;font-weight: 500;}
        .warn-warning {color: #ff9500;font-weight: 500;}
        .warn-danger {color: #ff3b30;font-weight: 500;}
        .profit-positive {color: #ff3b30;}
        .profit-negative {color: #34c759;}
        .profit-rate {font-size: 12px; margin-left: 3px;}
    </style>
</head>
<body>
<div class="card">
    <h2>ATRç½‘æ ¼è®¡ç®—å™¨</h2>
    <div class="version">V6.1 ç²¾å‡†æˆäº¤ç‰ˆ</div>

    <div class="section-title">ğŸ“Š åŸºç¡€è¡Œæƒ…æ•°æ®</div>
    <div class="input-group">
        <label>ç½‘æ ¼åŸºå‡†ä»·</label>
        <input type="text" inputmode="decimal" id="price" placeholder="è‚¡ç¥¨æˆæœ¬ä»·">
    </div>
    <div class="input-group">
        <label>ATR æŒ‡æ ‡å€¼</label>
        <input type="text" inputmode="decimal" id="atr" placeholder="ATR(14)">
    </div>

    <div class="section-title">âš™ï¸ ç½‘æ ¼ç­–ç•¥è®¾ç½®</div>
    <div class="input-group">
        <label>é£é™©å€æ•° (M)</label>
        <span class="tip">1.2(æ¿€è¿›) | 1.5(å¹³è¡¡) | 2.0(ç¨³å¥)</span>
        <input type="text" inputmode="decimal" id="multiplier" value="1.5">
    </div>

    <div class="section-title">ğŸ›¡ï¸ é˜²å®ˆæ¨¡å¼é€‰æ‹©</div>
    <div class="input-group">
        <label>é€‰æ‹©æ¨¡å¼</label>
        <select id="defenseMode" onchange="toggleMode()">
            <option value="stable">ç¨³å¥æ”¯æ’‘æ¨¡å¼(å›ºå®šä»·æ ¼)</option>
            <option value="aggressive">æ¿€è¿›é˜²å®ˆæ¨¡å¼(5å€ATRåŠ¨æ€)</option>
        </select>
        <div id="modeHint" class="mode-desc">ç¨³å¥æ¨¡å¼ï¼šæ­»å®ˆå‰ä½æ”¯æ’‘ä½ï¼Œé€‚åˆç®±ä½“è‚¡ã€‚</div>
    </div>

    <div class="input-group" id="supportInputGroup">
        <label>æ”¯æ’‘ä½ä»·æ ¼</label>
        <input type="text" inputmode="decimal" id="support" placeholder="æ­¢æŸä»·">
    </div>

    <div class="input-group">
        <label>æ¯ç¬”ä¹°å…¥è‚¡æ•°</label>
        <input type="text" inputmode="decimal" id="qty" value="100">
    </div>

    <div class="btn-group">
        <button class="btn-primary" onclick="runAnalysis()">ç”Ÿæˆå®æˆ˜æ–¹æ¡ˆ</button>
        <button class="btn-clear" onclick="clearInputs()">æ¸…é™¤</button>
    </div>

    <div id="result">
        <div id="levelText" style="font-weight:600;font-size:15px;line-height:1.8;margin-bottom:18px;"></div>

        <div class="section-title">ğŸš© ç½‘æ ¼äº¤æ˜“æ¡ä»¶å•</div>
        <div class="grid-info" id="gridInfo"></div>

        <div class="section-title">ğŸ¯ ç›®æ ‡ä»·ä¸åˆ©æ¶¦(å•æ ¼)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:15px;">
            <div class="info-card">ä¸‹æ¡£ä¹°å…¥ <span id="nextBuy" class="val" style="color:#34c759;"></span></div>
            <div class="info-card">ä¸‹æ¡£å–å‡º <span id="nextSell" class="val" style="color:#ff3b30;"></span></div>
        </div>

        <div style="margin-top:10px;">
            <div class="info-card">
                <div>å•æ ¼åˆ©æ¶¦ <span id="profit" class="val"></span></div>
                <div style="font-size:12px;color:#888;margin-top:6px;">æœªæ‰£é™¤æ‰‹ç»­è´¹</div>
            </div>
        </div>

        <div class="section-title">ğŸ’° èµ„é‡‘å‹åŠ›æµ‹è¯•</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:15px;">
            <div class="info-card">è¡¥ä»“æ¬¡æ•° <span id="count" class="val"></span></div>
            <div class="info-card">é˜²å®ˆä¸‹é™ <span id="finalLower" class="val" style="color:#ff3b30;"></span></div>
        </div>

        <div class="info-card" style="margin-top:10px;">
            éœ€å‡†å¤‡æ€»ç°é‡‘: <span id="totalCash" class="val" style="color:#ff3b30;"></span>
            <div id="cashWarn" style="font-size:12px;margin-top:5px;font-weight:600;"></div>
        </div>
    </div>
</div>

<script>
function toggleMode() {
    const mode = document.getElementById('defenseMode').value;
    const group = document.getElementById('supportInputGroup');
    const hint = document.getElementById('modeHint');
    if (mode === 'aggressive') {
        group.style.display = 'none';
        hint.innerText = "æ¿€è¿›æ¨¡å¼ï¼šåŸºäº5å€ATRè‡ªåŠ¨è®¡ç®—æ­¢æŸä½ã€‚";
    } else {
        group.style.display = 'block';
        hint.innerText = "ç¨³å¥æ¨¡å¼ï¼šæ­»å®ˆå‰ä½æ”¯æ’‘ä½ï¼Œé€‚åˆæ˜ç¡®åº•éƒ¨å¹³å°ã€‚";
    }
}

function getDecimalPlaces(numStr) {
    if (!numStr.includes('.')) return 2;
    const d = numStr.split('.')[1].length;
    return d >= 3 ? 3 : 2;
}

function runAnalysis() {
    const priceStr = document.getElementById('price').value.trim();
    const p = parseFloat(priceStr);
    const atr = parseFloat(document.getElementById('atr').value);
    const M = parseFloat(document.getElementById('multiplier').value);
    const mode = document.getElementById('defenseMode').value;
    const qty = parseInt(document.getElementById('qty').value) || 100;
    let supportVal = parseFloat(document.getElementById('support').value);

    if (isNaN(p) || p <= 0 || isNaN(atr) || atr <= 0 || isNaN(M) || M <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°å‚æ•°");
        return;
    }

    const decimals = getDecimalPlaces(priceStr);
    let finalSupport = mode === 'aggressive' ? (p - atr * 5) : supportVal;
    if (isNaN(finalSupport) || finalSupport >= p) {
        alert("æ”¯æ’‘ä½å¿…é¡»ä½äºå½“å‰ä»·ï¼");
        return;
    }

    const ATRP = (atr / p) * 100;
    const buyStep = ATRP * M;
    const sellStep = ATRP * M + 0.5;

    let reb;
    if (ATRP < 1.5) {
        reb = 0.5;
    } else if (ATRP < 3) {
        reb = 0.8;
    } else if (ATRP < 5) {
        reb = 1.0;
    } else {
        reb = 1.5;
    }

    // åŸå§‹ç†è®ºä»·æ ¼
    const buyPrice = p * (1 - buyStep / 100) * (1 + reb / 100);
    const sellPrice = p * (1 + sellStep / 100) * (1 - reb / 100);

    // ========== ä½ æŒ‡å®šçš„æ ¸å¿ƒé€»è¾‘ï¼šå…ˆå®šæ­»æˆäº¤ä»· ==========
    const finalBuyPrice = parseFloat(buyPrice.toFixed(decimals));
    const finalSellPrice = parseFloat(sellPrice.toFixed(decimals));

    // ç”¨å®šæ­»åçš„ä»·æ ¼ç®—åˆ©æ¶¦
    const profitPerShare = finalSellPrice - p;
    const totalProfit = profitPerShare * qty;
    const profitRate = ((profitPerShare / p) * 100).toFixed(2);

    // è®¡ç®—è¡¥ä»“æ¬¡æ•°ä¸çœŸå®èµ„é‡‘
    let tempPrice = p;
    let buyCount = 0;
    let totalCash = 0;
    const maxLoop = 50;
    let loop = 0;

    totalCash += p * qty;

    while (tempPrice * (1 - buyStep / 100) >= finalSupport - 0.001 && loop < maxLoop) {
        tempPrice *= (1 - buyStep / 100);
        const gridPrice = parseFloat(tempPrice.toFixed(decimals));
        totalCash += gridPrice * qty;
        buyCount++;
        loop++;
    }

    let level, advice, color;
    if (ATRP < 1.5) {
        level = "ä½æ³¢åŠ¨æ ‡çš„";
        advice = "âš ï¸ è¯¥æ ‡çš„æ³¢åŠ¨è¿‡å°ï¼Œå»ºè®®è°ƒå®½æ­¥é•¿æˆ–æ¢è‚¡ã€‚";
        color = "#8e8e93";
    } else if (ATRP < 3) {
        level = "ä¸­æ³¢åŠ¨æ ‡çš„";
        advice = "âœ… è¡¨ç°ç¨³å¥ï¼Œé€‚åˆæ ‡å‡†å®½å¹…éœ‡è¡ç½‘æ ¼ã€‚";
        color = "#007aff";
    } else if (ATRP < 5) {
        level = "é«˜æ³¢åŠ¨æ ‡çš„";
        advice = "ğŸš€ ä¼˜è´¨æ ‡çš„ï¼å¼¹æ€§å¥½ï¼Œå›æœ¬æ•ˆç‡é«˜ã€‚";
        color = "#ff3b30";
    } else {
        level = "æç«¯æ³¢åŠ¨æ ‡çš„";
        advice = "ğŸ”¥ é£é™©è¾ƒé«˜ï¼Œé¿å¼€è´¢æŠ¥/æ¶ˆæ¯çª—å£æœŸã€‚";
        color = "#ff9500";
    }

    document.getElementById('levelText').innerHTML = `
        ATRæ³¢åŠ¨å æ¯”ï¼š<span style="color:${color}">${ATRP.toFixed(2)}%</span><br>
        æ³¢åŠ¨ç­‰çº§ï¼š<span style="color:${color}">${level}</span><br>
        æ“ä½œå»ºè®®ï¼š${advice}
    `;

    document.getElementById('gridInfo').innerHTML =
        `ğŸš© ä¹°å…¥ï¼šè·Œ <span style="color:#34c759">-${buyStep.toFixed(2)}%</span> åå¼¹ <span style="color:#ff3b30">+${reb.toFixed(1)}%</span><br>
         ğŸš© å–å‡ºï¼šæ¶¨ <span style="color:#ff3b30">+${sellStep.toFixed(2)}%</span> å›è½ <span style="color:#34c759">-${reb.toFixed(1)}%</span>`;

    document.getElementById('nextBuy').innerText = finalBuyPrice.toFixed(decimals);
    document.getElementById('nextSell').innerText = finalSellPrice.toFixed(decimals);

    // åˆ©æ¶¦æ˜¾ç¤ºï¼š+å·ã€æ— å…ƒã€ç™¾åˆ†æ¯”æ›´å°
    const profitSign = totalProfit >= 0 ? '+' : '';
    const profitText = profitSign + totalProfit.toFixed(2);
    const rateSign = profitRate >= 0 ? '+' : '';
    const rateText = rateSign + profitRate;

    const profitCls = totalProfit >= 0 ? "profit-positive" : "profit-negative";
    const rateCls = profitRate >= 0 ? "profit-positive profit-rate" : "profit-negative profit-rate";

    document.getElementById('profit').innerHTML = `
        <span class="${profitCls}">${profitText}</span>
        <span class="${rateCls}">${rateText}%</span>
    `;

    document.getElementById('count').innerText = buyCount + " æ¬¡";
    const modeTag = mode === 'aggressive' ? " (5x ATR)" : "";
    document.getElementById('finalLower').innerText = finalSupport.toFixed(decimals) + modeTag;

    document.getElementById('totalCash').innerHTML = `${Math.round(totalCash)} å…ƒ<span style="font-size:11px;color:#888;">ï¼ˆå«åˆå§‹åº•ä»“ï¼‰</span>`;

    let warnClass, warnText;
    if (buyCount < 3) {
        warnClass = "warn-safe"; warnText = "âœ… å‹åŠ›æå°ï¼Œå®‰å…¨å¯æ§";
    } else if (buyCount <= 5) {
        warnClass = "warn-warning"; warnText = "âš ï¸ å‹åŠ›ä¸­ç­‰ï¼Œåˆç†ä»“ä½";
    } else {
        warnClass = "warn-danger"; warnText = "âŒ å‹åŠ›è¿‡å¤§ï¼Œå»ºè®®åŠ å®½ç½‘æ ¼";
    }
    document.getElementById('cashWarn').className = warnClass;
    document.getElementById('cashWarn').innerText =
        `æé™å›æ’¤ï¼šè‹¥è·Œè‡³ ${finalSupport.toFixed(decimals)}ï¼Œæµ®äºçº¦ ${(((finalSupport - p) / p * 100)).toFixed(1)}% | ${warnText}`;

    document.getElementById('result').classList.add('show');
}

function clearInputs() {
    document.getElementById('price').value = '';
    document.getElementById('atr').value = '';
    document.getElementById('support').value = '';
    document.getElementById('result').classList.remove('show');
}
</script>
</body>
</html>
