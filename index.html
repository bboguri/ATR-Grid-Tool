<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATRç½‘æ ¼è®¡ç®—å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #f4f7f9; 
            padding: 15px; 
            display: flex; 
            justify-content: center; 
            line-height: 1.5;
        }
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            width: 100%; 
            max-width: 500px; 
        }
        h2 { 
            color: #1d1d1f; 
            text-align: center; 
            margin-bottom: 6px; 
            font-weight: 600;
            font-size: 20px;
        }
        .version {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-bottom: 20px;
        }
        .section-title { 
            font-size: 16px; 
            font-weight: 600; 
            color: #007aff; 
            margin: 20px 0 12px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 6px;
        }
        .input-group { 
            margin-bottom: 18px; 
        }
        label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .tip { 
            font-size: 12px; 
            color: #888; 
            display: block; 
            margin-bottom: 6px; 
        }
        input, select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 15px;
            transition: all 0.2s ease;
        }
        input:focus, select:focus { 
            border-color: #007aff; 
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2);
        }
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        button { 
            padding: 14px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.25s ease;
        }
        .btn-primary {
            background: #007aff; 
            color: white; 
        }
        .btn-clear {
            background: #e6e6e6;
            color: #666;
        }
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background: #0066cc;
        }
        .btn-clear:hover {
            background: #d2d2d2;
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        #result { 
            margin-top: 20px; 
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #result.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .grid-info { font-size: 16px; line-height: 2.2; }
        .info-card { 
            background: #f9fafc; 
            padding: 12px 15px; 
            border-radius: 8px; 
            border: 1px solid #eee; 
        }
        .val { 
            display: inline; 
            font-size: 18px; 
            font-weight: bold;
        }
        .mode-desc { font-size: 11px; color: #888; margin-top: 4px; }
        
        .warn-safe { color: #34c759; font-weight: 500; }
        .warn-warning { color: #ff9500; font-weight: 500; }
        .warn-danger { color: #ff3b30; font-weight: 500; }

        .profit-positive { color: #ff3b30; }
        .profit-negative { color: #34c759; }

        .profit-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>ATRç½‘æ ¼è®¡ç®—å™¨</h2>
    <div class="version">V6.0 ç¨³å®šç‰ˆ</div>

    <div class="section-title">ğŸ“Š åŸºç¡€è¡Œæƒ…æ•°æ®</div>
    <div class="input-group">
        <label>è‚¡ä»·</label>
        <input type="text" inputmode="decimal" id="price" placeholder="ç½‘æ ¼åŸºå‡†ä»·">
    </div>
    <div class="input-group">
        <label>ATR æŒ‡æ ‡å€¼</label>
        <input type="text" inputmode="decimal" id="atr" placeholder="ATR(14)">
    </div>

    <div class="section-title">âš™ï¸ ç½‘æ ¼ç­–ç•¥è®¾ç½®</div>
    <div class="input-group">
        <label>é£é™©å€æ•° (Multiplier)</label>
        <span class="tip">1.2(æ¿€è¿›åˆ·å•) | 1.5(é»˜è®¤å¹³è¡¡) | 2.0(ç¨³å¥)</span>
        <input type="text" inputmode="decimal" id="multiplier" value="1.5">
    </div>

    <div class="section-title">ğŸ›¡ï¸ é˜²å®ˆæ¨¡å¼é€‰æ‹©</div>
    <div class="input-group">
        <label>é€‰æ‹©æ¨¡å¼</label>
        <select id="defenseMode" onchange="toggleMode()">
            <option value="stable">ç¨³å¥æ”¯æ’‘æ¨¡å¼ (å›ºå®šä»·æ ¼)</option>
            <option value="aggressive">æ¿€è¿›é˜²å®ˆæ¨¡å¼ (5å€ATRåŠ¨æ€)</option>
        </select>
        <div id="modeHint" class="mode-desc">ç¨³å¥æ¨¡å¼ï¼šæ­»å®ˆå‰ä½æ”¯æ’‘ä½ï¼Œé€‚åˆç®±ä½“è‚¡ã€‚</div>
    </div>
    <div class="input-group" id="supportInputGroup">
        <label>æ”¯æ’‘ä½ä»·æ ¼</label>
        <input type="text" inputmode="decimal" id="support" placeholder="æ­¢æŸä»·">
    </div>

    <div class="input-group">
        <label>æ¯ç¬”ä¹°å…¥è‚¡æ•°</label>
        <input type="text" inputmode="decimal" id="qty" value="100">
    </div>

    <div class="btn-group">
        <button class="btn-primary" onclick="runAnalysis()">ç”Ÿæˆå®æˆ˜æ–¹æ¡ˆ</button>
        <button class="btn-clear" onclick="clearInputs()">æ¸…é™¤</button>
    </div>

    <div id="result">
        <div id="levelText" style="font-weight: 600; font-size:16px; line-height:1.8; margin-bottom:18px;"></div>

        <div class="section-title">ğŸš© ç½‘æ ¼äº¤æ˜“æ¡ä»¶å•</div>
        <div class="grid-info" id="gridInfo"></div>

        <div class="section-title">ğŸ¯ ç›®æ ‡ä»·ä¸åˆ©æ¶¦ (å•æ ¼)</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
            <div class="info-card">ä¸‹æ¡£ä¹°å…¥ <span id="nextBuy" class="val" style="color:#34c759;"></span></div>
            <div class="info-card">ä¸‹æ¡£å–å‡º <span id="nextSell" class="val" style="color:#ff3b30;"></span></div>
        </div>

        <div style="margin-top:10px;">
            <div class="info-card">
                <div class="profit-row">
                    <div>å•æ ¼åˆ©æ¶¦ <span id="profit" class="val"></span></div>
                    <div>æ”¶ç›Šç‡ <span id="profitRateDisplay" class="val"></span></div>
                </div>
                <div style="font-size:11px; color:#888; margin-top:6px;">æœªæ‰£é™¤æ‰‹ç»­è´¹</div>
            </div>
        </div>

        <div class="section-title">ğŸ’° èµ„é‡‘å‹åŠ›æµ‹è¯•</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
            <div class="info-card">è¡¥ä»“æ¬¡æ•° <span id="count" class="val"></span></div>
            <div class="info-card">é˜²å®ˆä¸‹é™ <span id="finalLower" class="val" style="color:#ff3b30;"></span></div>
        </div>
        <div class="info-card" style="margin-top:10px;">
            éœ€å‡†å¤‡æ€»ç°é‡‘: <span id="totalCash" class="val" style="color:#ff3b30;"></span>
            <div id="cashWarn" style="font-size:12px; margin-top:5px; font-weight:600;"></div>
        </div>
    </div>
</div>

<script>
function toggleMode() {
    const mode = document.getElementById('defenseMode').value;
    const group = document.getElementById('supportInputGroup');
    const hint = document.getElementById('modeHint');
    if (mode === 'aggressive') {
        group.style.display = 'none';
        hint.innerText = "æ¿€è¿›æ¨¡å¼ï¼šåŸºäº 5 å€ ATR è‡ªåŠ¨è®¡ç®—æ­¢æŸä½ã€‚";
    } else {
        group.style.display = 'block';
        hint.innerText = "ç¨³å¥æ¨¡å¼ï¼šæ­»å®ˆå‰ä½æ”¯æ’‘ä½ï¼Œé€‚åˆæ˜ç¡®åº•éƒ¨å¹³å°ã€‚";
    }
}

function runAnalysis() {
    const p = parseFloat(document.getElementById('price').value);
    const atr = parseFloat(document.getElementById('atr').value);
    const m = parseFloat(document.getElementById('multiplier').value);
    const mode = document.getElementById('defenseMode').value;
    const qty = parseInt(document.getElementById('qty').value);
    let support = parseFloat(document.getElementById('support').value);

    if (isNaN(p) || p <= 0 || isNaN(atr) || atr <= 0 || isNaN(m) || m <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°å‚æ•°");
        return;
    }

    let finalSupport = mode === 'aggressive' ? (p - atr * 5) : support;
    if (isNaN(finalSupport) || finalSupport >= p) {
        alert("æ”¯æ’‘ä½å¿…é¡»ä½äºå½“å‰ä»·ï¼");
        return;
    }

    const atrp = (atr / p) * 100;
    let reb, level, advice;

    if (atrp < 1.5) {
        level = "ä½æ³¢åŠ¨æ ‡çš„";
        reb = 0.5;
        advice = "âš ï¸ è¯¥æ ‡çš„æ³¢åŠ¨è¿‡å°ï¼Œå»ºè®®è°ƒå®½æ­¥é•¿æˆ–æ¢è‚¡ã€‚";
    } else if (atrp >= 1.5 && atrp < 3.0) {
        level = "ä¸­æ³¢åŠ¨æ ‡çš„";
        reb = 0.8;
        advice = "âœ… è¡¨ç°ç¨³å¥ï¼Œé€‚åˆæ ‡å‡†å®½å¹…éœ‡è¡ç½‘æ ¼ã€‚";
    } else if (atrp >= 3.0 && atrp < 5.0) {
        level = "é«˜æ³¢åŠ¨æ ‡çš„";
        reb = 1.0;
        advice = "ğŸš€ ä¼˜è´¨æ ‡çš„ï¼å¼¹æ€§å¥½ï¼Œå›æœ¬æ•ˆç‡é«˜ã€‚";
    } else {
        level = "æç«¯æ³¢åŠ¨æ ‡çš„";
        reb = 1.5;
        advice = "ğŸ”¥ é£é™©è¾ƒé«˜ï¼Œé¿å¼€è´¢æŠ¥/æ¶ˆæ¯çª—å£æœŸã€‚";
    }

    let buyStepPct = atrp * m;
    if (buyStepPct < 0.1) buyStepPct = 0.1;
    const sellStepPct = buyStepPct + 0.5;

    let buyCount = 0;
    let totalBuyCash = p * qty;
    let tempPrice = p;
    const maxLoop = 50;
    let loop = 0;

    while (tempPrice * (1 - buyStepPct / 100) >= finalSupport - 0.001 && loop < maxLoop) {
        tempPrice = tempPrice * (1 - buyStepPct / 100);
        buyCount++;
        totalBuyCash += tempPrice * qty;
        loop++;
    }

    const finalTotalShares = (buyCount + 1) * qty;

    const nBuy = p * (1 - buyStepPct / 100);
    const nSell = nBuy * (1 + sellStepPct / 100);
    const profit = (nSell - nBuy) * qty;
    const profitRate = ((profit / (nBuy * qty)) * 100).toFixed(2);

    const finalValue = finalSupport * finalTotalShares;
    const maxDrawdown = ((finalValue - totalBuyCash) / totalBuyCash * 100).toFixed(2);

    const resDiv = document.getElementById('result');
    resDiv.classList.remove('show');
    void resDiv.offsetWidth;
    resDiv.classList.add('show');

    let color;
    if (atrp < 1.5) color = "#8e8e93";
    else if (atrp < 3.0) color = "#007aff";
    else if (atrp < 5.0) color = "#ff3b30";
    else color = "#ff9500";

    document.getElementById('levelText').innerHTML = `
        ATR æ³¢åŠ¨å æ¯”ï¼š<span style="color:${color}">${atrp.toFixed(2)}%</span><br>
        æ³¢åŠ¨ç­‰çº§ï¼š<span style="color:${color}">${level}</span><br>
        æ“ä½œå»ºè®®ï¼š${advice}
    `;

    document.getElementById('gridInfo').innerHTML =
        `ğŸš© ä¹°å…¥ï¼šè·Œ <span style="color:#34c759">-${buyStepPct.toFixed(2)}%</span> åå¼¹ <span style="color:#ff3b30">+${reb.toFixed(1)}%</span><br>
         ğŸš© å–å‡ºï¼šæ¶¨ <span style="color:#ff3b30">+${sellStepPct.toFixed(2)}%</span> å›è½ <span style="color:#34c759">-${reb.toFixed(1)}%</span>`;

    document.getElementById('nextBuy').innerText = nBuy.toFixed(2);
    document.getElementById('nextSell').innerText = nSell.toFixed(2);
    
    const profitCls = profit >= 0 ? "profit-positive" : "profit-negative";
    const rateCls = profitRate >= 0 ? "profit-positive" : "profit-negative";
    
    document.getElementById('profit').innerHTML = `<span class="${profitCls}">${profit.toFixed(2)} å…ƒ</span>`;
    document.getElementById('profitRateDisplay').innerHTML = `<span class="${rateCls}">${profitRate}%</span>`;

    document.getElementById('count').innerText = buyCount + " æ¬¡";
    const modeTag = mode === 'aggressive' ? " (5x ATR)" : "";
    document.getElementById('finalLower').innerText = finalSupport.toFixed(2) + modeTag;

    document.getElementById('totalCash').innerHTML = `
        ${totalBuyCash.toFixed(0)} å…ƒ
        <span style="font-size:11px; color:#888; font-weight:normal;">ï¼ˆå«åˆå§‹åº•ä»“ï¼‰</span>
    `;

    let warnClass, warnText;
    if (buyCount < 3) {
        warnClass = "warn-safe";
        warnText = "âœ… å‹åŠ›æå°ï¼Œå®‰å…¨å¯æ§";
    } else if (buyCount <= 5) {
        warnClass = "warn-warning";
        warnText = "âš ï¸ å‹åŠ›ä¸­ç­‰ï¼Œåˆç†ä»“ä½";
    } else {
        warnClass = "warn-danger";
        warnText = "âŒ å‹åŠ›è¿‡å¤§ï¼Œå»ºè®®åŠ å®½ç½‘æ ¼";
    }
    document.getElementById('cashWarn').className = warnClass;
    document.getElementById('cashWarn').innerText =
        `æé™å›æ’¤ï¼šè‹¥è·Œè‡³ ${finalSupport.toFixed(2)}ï¼Œæµ®äºçº¦ ${maxDrawdown}% | ${warnText}`;

    setTimeout(() => {
        resDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

function clearInputs() {
    document.getElementById('price').value = '';
    document.getElementById('atr').value = '';
    document.getElementById('support').value = '';
    const res = document.getElementById('result');
    res.classList.remove('show');
    setTimeout(() => { res.style.display = 'none'; }, 300);
    document.getElementById('price').focus();
}
</script>
</body>
</html>
